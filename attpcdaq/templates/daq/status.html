{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}Status - AT-TPC DAQ{% endblock %}

{% block body %}
    <div class="panel panel-default">
        <div class="panel-heading">
            DAQ Status
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-8">
                    <h4>Overall status: <span class="label label-success">Idle</span></h4>
                </div>
                <div class="col-md-4 text-right">
                    <div class="btn-toolbar" id="run-control-toolbar">
                        <a class="btn btn-info"
                           href="{% url 'daq/set_state_all' 3 %}">
                            <span class="glyphicon glyphicon-off"></span> Init
                        </a>
                        <a class="btn btn-success"
                           href="{% url 'daq/set_state_all' 4 %}">
                            <span class="glyphicon glyphicon-play"></span> Start
                        </a>
                        <a class="btn btn-danger"
                           href="{% url 'daq/set_state_all' 3 %}">
                            <span class="glyphicon glyphicon-stop"></span> Stop
                        </a>
                        <a class="btn btn-warning"
                           href="{% url 'daq/set_state_all' 0 %}">
                            <span class="glyphicon glyphicon-repeat"></span> Reset
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <table class="table table-striped">
            <tr>
                <th>Name</th>
                <th>Status</th>
                <th>Config</th>
                <th class="shrink"></th>
            </tr>
            {% for source in data_sources %}
            <tr>
                <td>{{ source.name }}</td>
                <td id="{{ source.name }}-status-cell">
                    <span class="label label-default" data-pk="{{ source.pk }}" id="{{ source.name }}-status-label">
                        {{ source.get_state_display }}
                    </span>
                    <span class="fa fa-pulse fa-spinner" id="{{ source.name }}-status-spinner"></span>
                </td>
                <td>{{ source.config }}</td>
                <td class="text-right">
                    <div class="btn-toolbar" id="{{ source.name }}-source-controls">
                        <button class="btn btn-xs btn-info" data-pk="{{ source.pk }}" data-target="{{ source.DESCRIBED }}"
                                title="Describe" data-toggle="tooltip" data-placement="bottom">
                            <span class="fa fa-server"></span>
                        </button>
                        <button class="btn btn-xs btn-info" data-pk="{{ source.pk }}" data-target="{{ source.PREPARED }}"
                                title="Prepare" data-toggle="tooltip" data-placement="bottom">
                            <span class="fa fa-link"></span>
                        </button>
                        <button class="btn btn-xs btn-info" data-pk="{{ source.pk }}" data-target="{{ source.READY }}"
                                title="Configure" data-toggle="tooltip" data-placement="bottom">
                            <span class="fa fa-cog"></span>
                        </button>
                        <button class="btn btn-xs btn-success" data-pk="{{ source.pk }}" data-target="{{ source.RUNNING }}"
                                title="Start" data-toggle="tooltip" data-placement="bottom">
                            <span class="glyphicon glyphicon-play"></span>
                        </button>
                        <button class="btn btn-xs btn-danger" data-pk="{{ source.pk }}" data-target="{{ source.READY }}"
                                title="Stop" data-toggle="tooltip" data-placement="bottom">
                            <span class="glyphicon glyphicon-stop"></span>
                        </button>
                        <button class="btn btn-xs btn-warning" data-pk="{{ source.pk }}" data-target="{{ source.IDLE }}"
                                title="Reset" data-toggle="tooltip" data-placement="bottom">
                            <span class="glyphicon glyphicon-repeat"></span>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>


{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Set up the control buttons
        $("div[id*='source-controls'] > button").click(function () {
            var pk = $(this).data('pk');
            var target = $(this).data('target');
            $.post("{% url 'daq/source_change_state' %}", {pk: pk, target_state: target, csrfmiddlewaretoken: '{{ csrf_token }}'},
                    function (data) {
                        console.log(data);
                    });
        });

        // Hide spinners
        $('[id*="spinner"]').hide();

        // Enable tooltips
        $('[data-toggle="tooltip"]').tooltip();

        // Update the state of the sources
        setInterval(function () {
            $('[id*="status-cell"]').each(function () {
                var label = $(this).children('[id*="status-label"]');
                var pk = label.data('pk');
                var spinner = $(this).children('[id*="status-spinner"]');
                $.get("{% url 'daq/source_get_state' %}", {pk: pk}, function (data) {
                    $(label).text(data.state_name);
                    if (data.transitioning) {
                        spinner.show();
                        label.hide();
                    }
                    else {
                        spinner.hide();
                        label.show();
                    }
                });
            });


        }, 5000);
    });
</script>
{% endblock %}